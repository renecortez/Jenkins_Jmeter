pipeline{
agent any
    stages {
        /*stage('Reading Scenario Parameters') {
          steps {
                script{
                    params.each { key, value ->echo "${key}=${value}"}
                    
							if (params.TestType.equals("Custom")) {
								env."SCRIPT_DATA" = input(
									id: "Scripts_Input",
									message: "Enter Custom Data for Scripts",
									parameters: [
										[$class: 'GlobalVariableStringParameterDefinition', defaultValue: '', description: 'Global Test Duration', name: "Duration"],
										[$class: 'GlobalVariableStringParameterDefinition', defaultValue: '', description: '<<Load1>>;<<Load2>>;<<Load3>>;<<Load4>>;<<Load5>>', name: "Load"],
										[$class: 'GlobalVariableStringParameterDefinition', defaultValue: '', description: '<<TPS>>;<<TPS>>;<<TPS>>;<<TPS>>;<<TPS>>', name: "TPS"]
									]
								)
							
            					echo "To be returned: ${env.SCRIPT_DATA}"
            					
            					def varSplitedData = env.SCRIPT_DATA.split("[=,}]")
            					
            					//echo "Converted to array Load:" + varSplitedData[1]
            					//echo "Converted to array TPS:" + varSplitedData[3]
            					//echo "Converted to array Duration:" + varSplitedData[5]
            					env.finalDuration = varSplitedData[5]
            					echo "Final Custom Duration : ${env.finalDuration}"
            					
            					def AllTPS = varSplitedData[3]
            					def AllLoads = varSplitedData[1]
            
            					def varSplitedTPS = AllTPS.split(";")
            					def varSplitedLoad = AllLoads.split(";")
            					
            					env.finalTPS1 = varSplitedTPS[0]
            					env.finalTPS2 = varSplitedTPS[1]
            					env.finalTPS3 = varSplitedTPS[2]
            					env.finalTPS4 = varSplitedTPS[3]
            					env.finalTPS5 = varSplitedTPS[4]
            					
            					env.finalLoad1 = varSplitedLoad[0]
            					env.finalLoad2 = varSplitedLoad[1]
            					env.finalLoad3 = varSplitedLoad[2]
            					env.finalLoad4 = varSplitedLoad[3]
            					env.finalLoad5 = varSplitedLoad[4]
            					
            					echo "Final Scripts TPS : ${env.finalTPS1} - ${env.finalTPS2} - ${env.finalTPS3} - ${env.finalTPS4} - ${env.finalTPS5}"
            					echo "Final Scripts Loads : ${env.finalLoad1} - ${env.finalLoad2} - ${env.finalLoad3} - ${env.finalLoad4} - ${env.finalLoad5}"
					
					    }
				    }
                }
        }*/
        
        stage('Seting up Custom Scenario'){
            steps{
                script{
                if (params.TestType.equals("Custom")) {
                    //Set Test Duration
                    bat '''  
                        setlocal enabledelayedexpansion
                        set "filename=Jmeter_Scenarios"
                        set  "searchstr=<stringProp name=\\"Argument\\.name\\">Duration</stringProp><stringProp name=\\"Argument\\.value\\">([0-9]+)</stringProp>"
                        set "replacestr=<stringProp name=\\"Argument.name\\">Duration</stringProp><stringProp name=\\"Argument.value\\">%finalDuration%</stringProp>"
                        powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                        echo "Sendind Final Duration as:  %finalDuration%"
                    '''
                    //Set Load for Script 1 PF_Load
                   bat '''  
                        setlocal enabledelayedexpansion
                        set "filename=Jmeter_Scenarios"
                        set  "searchstr=<stringProp name=\\"Argument\\.name\\">PF_Load</stringProp><stringProp name=\\"Argument\\.value\\">([0-9]+)</stringProp>"
                        set "replacestr=<stringProp name=\\"Argument.name\\">PF_Load</stringProp><stringProp name=\\"Argument.value\\">%finalLoad1%</stringProp>"
                        powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                        echo "Sendind first tps as:  %finalLoad1%"
                    '''
                //Set Load for Script 2 AA_Load
                   bat '''  
                        setlocal enabledelayedexpansion
                        set "filename=Jmeter_Scenarios"
                        set  "searchstr=<stringProp name=\\"Argument\\.name\\">AA_Load</stringProp><stringProp name=\\"Argument\\.value\\">([0-9]+)</stringProp>"
                        set "replacestr=<stringProp name=\\"Argument.name\\">AA_Load</stringProp><stringProp name=\\"Argument.value\\">%finalLoad2%</stringProp>"
                        powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                        echo "Sendind first tps as:  %finalLoad2%"
                    '''
                //Set Load for Script 3 DS_Load
                   bat '''  
                        setlocal enabledelayedexpansion
                        set "filename=Jmeter_Scenarios"
                        set  "searchstr=<stringProp name=\\"Argument\\.name\\">DS_Load</stringProp><stringProp name=\\"Argument\\.value\\">([0-9]+)</stringProp>"
                        set "replacestr=<stringProp name=\\"Argument.name\\">DS_Load</stringProp><stringProp name=\\"Argument.value\\">%finalLoad3%</stringProp>"
                        powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                        echo "Sendind first tps as:  %finalLoad3%"
                    '''
                //Set Load for Script 4 DP_Load
                   bat '''  
                        setlocal enabledelayedexpansion
                        set "filename=Jmeter_Scenarios"
                        set  "searchstr=<stringProp name=\\"Argument\\.name\\">DP_Load</stringProp><stringProp name=\\"Argument\\.value\\">([0-9]+)</stringProp>"
                        set "replacestr=<stringProp name=\\"Argument.name\\">DP_Load</stringProp><stringProp name=\\"Argument.value\\">%finalLoad4%</stringProp>"
                        powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                        echo "Sendind first tps as:  %finalLoad4%"
                    '''
                //Set Load for Script 5 DM_Load
                   bat '''  
                        setlocal enabledelayedexpansion
                        set "filename=Jmeter_Scenarios"
                        set  "searchstr=<stringProp name=\\"Argument\\.name\\">DM_Load</stringProp><stringProp name=\\"Argument\\.value\\">([0-9]+)</stringProp>"
                        set "replacestr=<stringProp name=\\"Argument.name\\">DM_Load</stringProp><stringProp name=\\"Argument.value\\">%finalLoad5%</stringProp>"
                        powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                        echo "Sendind first tps as:  %finalLoad5%"
                    '''   
                //Set TPS for Script 1 PF_TPS
                   bat '''  
                        setlocal enabledelayedexpansion
                        set "filename=Jmeter_Scenarios"
                        set  "searchstr=<stringProp name=\\"Argument\\.name\\">PF_TPS</stringProp><stringProp name=\\"Argument\\.value\\">([0-9]+)</stringProp>"
                        set "replacestr=<stringProp name=\\"Argument.name\\">PF_TPS</stringProp><stringProp name=\\"Argument.value\\">%finalTPS1%</stringProp>"
                        powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                        echo "Sendind first tps as:  %finalTPS1%"
                    '''   
                //Set TPS for Script 2 PF_TPS
                   bat '''  
                        setlocal enabledelayedexpansion
                        set "filename=Jmeter_Scenarios"
                        set  "searchstr=<stringProp name=\\"Argument\\.name\\">AA_TPS</stringProp><stringProp name=\\"Argument\\.value\\">([0-9]+)</stringProp>"
                        set "replacestr=<stringProp name=\\"Argument.name\\">AA_TPS</stringProp><stringProp name=\\"Argument.value\\">%finalTPS2%</stringProp>"
                        powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                        echo "Sendind first tps as:  %finalTPS2%"
                    '''   
                //Set TPS for Script 3 DS_TPS
                   bat '''  
                        setlocal enabledelayedexpansion
                        set "filename=Jmeter_Scenarios"
                        set  "searchstr=<stringProp name=\\"Argument\\.name\\">DS_TPS</stringProp><stringProp name=\\"Argument\\.value\\">([0-9]+)</stringProp>"
                        set "replacestr=<stringProp name=\\"Argument.name\\">DS_TPS</stringProp><stringProp name=\\"Argument.value\\">%finalTPS3%</stringProp>"
                        powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                        echo "Sendind first tps as:  %finalTPS3%"
                    '''   
                //Set TPS for Script 4 DS_TPS
                   bat '''  
                        setlocal enabledelayedexpansion
                        set "filename=Jmeter_Scenarios"
                        set  "searchstr=<stringProp name=\\"Argument\\.name\\">DP_TPS</stringProp><stringProp name=\\"Argument\\.value\\">([0-9]+)</stringProp>"
                        set "replacestr=<stringProp name=\\"Argument.name\\">DP_TPS</stringProp><stringProp name=\\"Argument.value\\">%finalTPS4%</stringProp>"
                        powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                        echo "Sendind first tps as:  %finalTPS4%"
                    '''   
                 //Set TPS for Script 5 DS_TPS
                   bat '''  
                        setlocal enabledelayedexpansion
                        set "filename=Jmeter_Scenarios"
                        set  "searchstr=<stringProp name=\\"Argument\\.name\\">DM_TPS</stringProp><stringProp name=\\"Argument\\.value\\">([0-9]+)</stringProp>"
                        set "replacestr=<stringProp name=\\"Argument.name\\">DM_TPS</stringProp><stringProp name=\\"Argument.value\\">%finalTPS5%</stringProp>"
                        powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                        echo "Sendind first tps as:  %finalTPS5%"
                    '''   
                    }
                }
            }	
        }

        stage('Enabling up Scenario'){
            steps{
                bat '''	
                @echo off
                setlocal enabledelayedexpansion
				set "filename=Jmeter_Scenarios"
				set "searchstr=<Arguments guiclass=\\"ArgumentsPanel\\" testclass=\\"Arguments\\" testname=\\"%TestType%\\" enabled=\\"false\\">"
                set "replacestr=<Arguments guiclass=\\"ArgumentsPanel\\" testclass=\\"Arguments\\" testname=\\"%TestType%\\" enabled=\\"true\\">"
				powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
			    echo "Enable scenario %TestType%"
				'''
            }	
        }
		stage('Run JMeter Scenario'){
			steps {
				bat """
					mkdir C:\\Users\\Rene\\Documents\\JMeterScripts\\Results\\${BUILD_NUMBER}_${TestType}\\HTML_Reports\\
					cd C:\\apache-jmeter-5.5\\bin
					jmeter -n -t Jmeter_Scenarios -l C:\\Users\\Rene\\Documents\\JMeterScripts\\Results\\${BUILD_NUMBER}_${TestType}\\PurchaseFlightReport.csv -e -o C:\\Users\\Rene\\Documents\\JMeterScripts\\Results\\${BUILD_NUMBER}_${TestType}\\HTML_Reports\\
				"""
			}
		}
		stage('Set Back All Test Types To False'){
			steps{
				bat '''
				    @echo off
				    setlocal enabledelayedexpansion
    				set "filename=Jmeter_Scenarios"
    				set "searchstr=<Arguments guiclass=\\"ArgumentsPanel\\" testclass=\\"Arguments\\" testname=\\"%TestType%\\" enabled=\\"true\\">"
                    set "replacestr=<Arguments guiclass=\\"ArgumentsPanel\\" testclass=\\"Arguments\\" testname=\\"%TestType%\\" enabled=\\"false\\">"
    				powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
    				echo "Disable Scenario %TestType%"
				'''
			 }
		}
		stage('Set Environment used on HTML Report'){
			steps{
				bat '''
				    @echo off
				    setlocal enabledelayedexpansion
                    set "filename=C:\\Users\\Rene\\Documents\\JMeterScripts\\Results\\%BUILD_NUMBER%_%TestType%\\HTML_Reports\\index.html"
                    set "searchstr=<tr><td>Test Type</td><td>\\"Not Set\\"</td></tr>"
                    set "replacestr=<tr><td>Test Type</td><td>\\"%TestType%\\"</td></tr>"
                    powershell -Command "(Get-Content \'%filename%\') -replace \'%searchstr%\', \'%replacestr%\' | Set-Content \'%filename%\'"
                    echo "Set scenario Name:%TestType%"
                '''
			 }
		}
	}
}
